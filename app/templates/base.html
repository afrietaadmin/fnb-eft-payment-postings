<!DOCTYPE html>
<html>
<head>
    <title>FNB EFT Payment Postings</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="csrf-token" content="{{ csrf_token() }}">

    <!-- Design System CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/variables.css') }}?v=2.1">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}?v=2.1">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/layout.css') }}?v=2.1">

    <!-- Component CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/buttons.css') }}?v=2.1">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/forms.css') }}?v=2.1">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/cards.css') }}?v=2.1">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/tables.css') }}?v=2.1">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/badges.css') }}?v=2.1">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/modals.css') }}?v=2.1">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/alerts.css') }}?v=2.1">

    <!-- Vibrant Theme Overrides (loads last to override all other styles) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/theme-vibrant.css') }}?v=2.1">
</head>
<body>
    <div class="notification-container" id="notificationContainer"></div>
    <header>
        <h1>FNB EFT Payment Postings</h1>
        <p>Transaction Management System</p>
    </header>
    <nav>
        <div class="nav-links">
            <a href="/">Dashboard</a>
            <a href="/transactions">Transactions</a>
            <a href="/transaction-history">History (45d)</a>
            <a href="/failed">Failed</a>
            <a href="/quotes">Quotes</a>
            <a href="/customer-analysis">Customer Analysis</a>
            <a href="{{ url_for('suspension.list_suspensions') }}">Suspensions</a>
            {% if current_user.is_authenticated and current_user.role == 'admin' %}
            <a href="/execution-logs">Logs</a>
            <a href="{{ url_for('auth.users_page') }}">ðŸ‘¥ Users</a>
            <a href="{{ url_for('auth.activity_logs_page') }}">ðŸ“Š Activity</a>
            {% endif %}
        </div>
        <div class="nav-user">
            {% if current_user.is_authenticated %}
            <button class="refresh-btn" onclick="refreshAllData()" title="Refresh all customer data from UISP">
                <span>ðŸ”„</span>
                <span id="refresh-text">Refresh Data</span>
            </button>
            <div class="user-info">
                ðŸ‘¤ {{ current_user.full_name or current_user.username }}
                {% if current_user.role == 'admin' %}<span style="background: #f39c12; padding: 2px 6px; border-radius: 3px; font-size: 11px;">ADMIN</span>{% endif %}
            </div>
            <div class="dropdown">
                <button class="dropdown-btn">Settings â–¼</button>
                <div class="dropdown-content">
                    <a href="{{ url_for('auth.change_password_page') }}">ðŸ”‘ Change Password</a>
                    <a href="{{ url_for('auth.logout') }}" style="color: #e74c3c;">ðŸšª Logout</a>
                </div>
            </div>
            {% endif %}
        </div>
    </nav>
    <div class="container">
        {% block content %}{% endblock %}
    </div>

    <script>
    function showNotification(title, message, type = 'info', duration = 5000) {
        const container = document.getElementById('notificationContainer');

        const notification = document.createElement('div');
        notification.className = `notification ${type}`;

        const iconMap = {
            success: 'âœ“',
            error: 'âœ•',
            info: 'â„¹'
        };

        notification.innerHTML = `
            <div class="notification-icon">${iconMap[type] || 'â„¹'}</div>
            <div class="notification-content">
                <div class="notification-title">${title}</div>
                <div class="notification-message">${message}</div>
                <div class="notification-progress">
                    <div class="notification-progress-bar" style="animation: progressFade ${duration}ms linear;"></div>
                </div>
            </div>
        `;

        container.appendChild(notification);

        // Auto-remove after duration
        setTimeout(() => {
            notification.style.animation = 'notificationSlideOut 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards';
            setTimeout(() => notification.remove(), 400);
        }, duration);

        return notification;
    }

    function refreshAllData() {
        const btn = event.target.closest('.refresh-btn');
        const textEl = document.getElementById('refresh-text');

        // Prevent multiple clicks
        if (btn.classList.contains('loading')) {
            return;
        }

        // Show loading state
        btn.classList.add('loading');
        textEl.innerHTML = '<span class="refresh-spinner"></span> Refreshing...';

        // Show initial notification
        showNotification('Syncing UISP Data', 'Fetching latest customer information...', 'info', 8000);

        // Call refresh endpoint with CSRF token
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
        fetch('{{ url_for("suspension.api_refresh_all_customers") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            btn.classList.remove('loading');

            if (data.status === 'success') {
                textEl.innerHTML = 'âœ“ Refresh Data';
                showNotification(
                    'UISP Sync Complete',
                    `Updated ${data.refresh_count}/${data.total_customers} customers in ${data.elapsed_seconds.toFixed(1)}s`,
                    'success',
                    5000
                );

                // Reset button after 2 seconds
                setTimeout(() => {
                    textEl.innerHTML = 'ðŸ”„ Refresh Data';
                }, 2000);
            } else {
                textEl.innerHTML = 'ðŸ”„ Refresh Data';
                showNotification(
                    'Sync Failed',
                    data.error || 'Unknown error occurred during sync',
                    'error',
                    5000
                );
            }
        })
        .catch(error => {
            btn.classList.remove('loading');
            textEl.innerHTML = 'ðŸ”„ Refresh Data';
            console.error('Error:', error);
            showNotification('Sync Error', 'Failed to refresh data from UISP', 'error', 5000);
        });
    }

    function showToast(message, type) {
        const toast = document.createElement('div');
        toast.className = `refresh-toast ${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);

        // Auto-remove after 5 seconds
        setTimeout(() => {
            toast.style.animation = 'slideIn 0.3s ease-out reverse';
            setTimeout(() => toast.remove(), 300);
        }, 5000);
    }

    // Mark current page link as active
    function highlightCurrentPage() {
        const currentPath = window.location.pathname;
        const navLinks = document.querySelectorAll('nav a');

        navLinks.forEach(link => {
            const href = link.getAttribute('href');

            // Check if link matches current path
            if (href === currentPath || (currentPath === '/' && href === '/')) {
                link.classList.add('active');
            } else if (currentPath.startsWith(href) && href !== '/') {
                link.classList.add('active');
            } else {
                link.classList.remove('active');
            }
        });
    }

    // Display flash messages as fancy notifications
    document.addEventListener('DOMContentLoaded', function() {
        highlightCurrentPage();
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    showNotification(
                        '{{ 'Success' if category == 'success' else 'Info' if category == 'info' else 'Warning' if category == 'warning' else 'Error' }}',
                        '{{ message }}',
                        '{{ category }}',
                        5000
                    );
                {% endfor %}
            {% endif %}
        {% endwith %}

        // Also show login sync notification if data was synced (session method)
        console.log('Session data:', {
            login_sync_success: {{ 'true' if session.get('login_sync_success') else 'false' }},
            login_sync_error: {{ 'true' if session.get('login_sync_error') else 'false' }},
            login_sync_count: {{ session.get('login_sync_count', 0) }},
            login_sync_total: {{ session.get('login_sync_total', 0) }}
        });
        {% if session.get('login_sync_success') %}
            showNotification(
                'UISP Data Synced',
                `Updated {{ session.get('login_sync_count', 0) }}/{{ session.get('login_sync_total', 0) }} customers on login`,
                'success',
                5000
            );
        {% elif session.get('login_sync_error') %}
            showNotification(
                'Sync Incomplete',
                'Some customer data could not be refreshed on login',
                'error',
                5000
            );
        {% endif %}
    });
    </script>
</body>
</html>
