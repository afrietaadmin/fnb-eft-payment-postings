{% extends "base.html" %}
{% block content %}
<h2>Customer Analysis</h2>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h3>UISP Payment Analysis</h3>
            <p style="color: #666; margin-top: 5px;">
                {% if stats.last_fetch %}
                    Last updated: {{ stats.last_fetch.strftime('%Y-%m-%d %H:%M:%S') }}
                {% else %}
                    No data fetched yet
                {% endif %}
            </p>
        </div>
        <a href="/customer-analysis?action=refresh" class="btn btn-primary">Refresh Data from UISP</a>
    </div>
</div>

<!-- Statistics Overview -->
<div class="stats">
    <div class="stat-box">
        <div class="stat-number">{{ stats.total_uisp_payments }}</div>
        <div class="stat-label">Total UISP Payments</div>
    </div>
    <div class="stat-box">
        <div class="stat-number" style="color: #e74c3c;">{{ stats.duplicates_1month.clients_affected }}</div>
        <div class="stat-label">Clients with Duplicates (1 Month)</div>
    </div>
    <div class="stat-box">
        <div class="stat-number" style="color: #f39c12;">{{ stats.duplicates_3months.clients_affected }}</div>
        <div class="stat-label">Clients with Duplicates (3 Months)</div>
    </div>
    <div class="stat-box">
        <div class="stat-number" style="color: #3498db;">{{ stats.duplicates_6months.clients_affected }}</div>
        <div class="stat-label">Clients with Duplicates (6 Months)</div>
    </div>
    <div class="stat-box">
        <div class="stat-number" style="color: #9b59b6;">{{ stats.incorrect_references.clients_affected }}</div>
        <div class="stat-label">Clients with Wrong References</div>
    </div>
</div>

<!-- Duplicate Payments Section -->
<div class="card">
    <h3>Duplicate Payment Detection</h3>
    <p style="color: #666; margin-bottom: 20px;">
        Detecting payments with the same amount posted to UISP within a configurable window (currently <strong>6 days</strong>) for the same customer.
        <br>
        <span style="font-size: 12px; color: #999;">Example: If a payment was posted on Oct 29, and another identical amount for the same client was posted on Nov 1 (3 days later), it will be flagged as a duplicate.</span>
        <br>
        <span style="font-size: 12px; color: #999;">Configure window in .env: DUPLICATE_WINDOW_DAYS</span>
    </p>

    <!-- Tabs for different time periods -->
    <div style="border-bottom: 2px solid #ecf0f1; margin-bottom: 20px;">
        <button class="tab-btn active" onclick="switchTab('1month')">1 Month ({{ stats.duplicates_1month.clients_affected }} clients)</button>
        <button class="tab-btn" onclick="switchTab('3months')">3 Months ({{ stats.duplicates_3months.clients_affected }} clients)</button>
        <button class="tab-btn" onclick="switchTab('6months')">6 Months ({{ stats.duplicates_6months.clients_affected }} clients)</button>
    </div>

    <!-- 1 Month Tab -->
    <div id="tab-1month" class="tab-content active">
        {% if duplicates_1m %}
            <table>
                <thead>
                    <tr>
                        <th>Client ID</th>
                        <th>Amount (ZAR)</th>
                        <th>Occurrences</th>
                        <th>Payment Dates</th>
                        <th>Days Apart</th>
                    </tr>
                </thead>
                <tbody>
                    {% for client_id, issues in duplicates_1m.items() %}
                        {% for issue in issues %}
                        <tr>
                            <td><strong>{{ client_id }}</strong></td>
                            <td>R {{ "%.2f"|format(issue.payment.amount) }}</td>
                            <td><span class="badge badge-danger">{{ issue.count }} times</span></td>
                            <td>
                                <strong>{{ issue.payment.created_date.strftime('%Y-%m-%d') }}</strong>
                                {% for match in issue.matches[:3] %}
                                    <br><span style="color: #666;">← {{ match.created_date.strftime('%Y-%m-%d') }}</span>
                                {% endfor %}
                                {% if issue.matches|length > 3 %}
                                    <br><span style="color: #999;">... +{{ issue.matches|length - 3 }} more</span>
                                {% endif %}
                            </td>
                            <td>
                                {% for days in issue.days_apart[:3] %}
                                    <div><span class="badge badge-warning">{{ days }} days</span></div>
                                {% endfor %}
                            </td>
                        </tr>
                        {% endfor %}
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p style="text-align: center; color: #999; padding: 40px 0;">No duplicates found in the last month</p>
        {% endif %}
    </div>

    <!-- 3 Months Tab -->
    <div id="tab-3months" class="tab-content">
        {% if duplicates_3m %}
            <table>
                <thead>
                    <tr>
                        <th>Client ID</th>
                        <th>Amount (ZAR)</th>
                        <th>Occurrences</th>
                        <th>Payment Dates</th>
                        <th>Days Apart</th>
                    </tr>
                </thead>
                <tbody>
                    {% for client_id, issues in duplicates_3m.items() %}
                        {% for issue in issues %}
                        <tr>
                            <td><strong>{{ client_id }}</strong></td>
                            <td>R {{ "%.2f"|format(issue.payment.amount) }}</td>
                            <td><span class="badge badge-warning">{{ issue.count }} times</span></td>
                            <td>
                                <strong>{{ issue.payment.created_date.strftime('%Y-%m-%d') }}</strong>
                                {% for match in issue.matches[:3] %}
                                    <br><span style="color: #666;">← {{ match.created_date.strftime('%Y-%m-%d') }}</span>
                                {% endfor %}
                                {% if issue.matches|length > 3 %}
                                    <br><span style="color: #999;">... +{{ issue.matches|length - 3 }} more</span>
                                {% endif %}
                            </td>
                            <td>
                                {% for days in issue.days_apart[:3] %}
                                    <div><span class="badge badge-warning">{{ days }} days</span></div>
                                {% endfor %}
                            </td>
                        </tr>
                        {% endfor %}
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p style="text-align: center; color: #999; padding: 40px 0;">No duplicates found in the last 3 months</p>
        {% endif %}
    </div>

    <!-- 6 Months Tab -->
    <div id="tab-6months" class="tab-content">
        {% if duplicates_6m %}
            <table>
                <thead>
                    <tr>
                        <th>Client ID</th>
                        <th>Amount (ZAR)</th>
                        <th>Occurrences</th>
                        <th>Payment Dates</th>
                        <th>Days Apart</th>
                    </tr>
                </thead>
                <tbody>
                    {% for client_id, issues in duplicates_6m.items() %}
                        {% for issue in issues %}
                        <tr>
                            <td><strong>{{ client_id }}</strong></td>
                            <td>R {{ "%.2f"|format(issue.payment.amount) }}</td>
                            <td><span class="badge" style="background: #e8f4f8; color: #2980b9;">{{ issue.count }} times</span></td>
                            <td>
                                <strong>{{ issue.payment.created_date.strftime('%Y-%m-%d') }}</strong>
                                {% for match in issue.matches[:3] %}
                                    <br><span style="color: #666;">← {{ match.created_date.strftime('%Y-%m-%d') }}</span>
                                {% endfor %}
                                {% if issue.matches|length > 3 %}
                                    <br><span style="color: #999;">... +{{ issue.matches|length - 3 }} more</span>
                                {% endif %}
                            </td>
                            <td>
                                {% for days in issue.days_apart[:3] %}
                                    <div><span class="badge" style="background: #e8f4f8; color: #2980b9;">{{ days }} days</span></div>
                                {% endfor %}
                            </td>
                        </tr>
                        {% endfor %}
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p style="text-align: center; color: #999; padding: 40px 0;">No duplicates found in the last 6 months</p>
        {% endif %}
    </div>
</div>

<!-- Incorrect Payment References Section -->
<div class="card">
    <h3>Customers with Incorrect Payment References</h3>
    <p style="color: #666; margin-bottom: 20px;">
        Customers who frequently use wrong payment references (CID was manually corrected).
    </p>

    {% if incorrect_refs %}
        <table>
            <thead>
                <tr>
                    <th>Client ID</th>
                    <th>Error Count</th>
                    <th>Recent Transactions</th>
                    <th>Details</th>
                </tr>
            </thead>
            <tbody>
                {% for cid, transactions in incorrect_refs.items() %}
                <tr>
                    <td><strong>{{ cid }}</strong></td>
                    <td><span class="badge badge-danger">{{ transactions|length }} errors</span></td>
                    <td>
                        {% for txn in transactions[:3] %}
                            <div style="font-size: 12px; margin-bottom: 5px;">
                                <strong>{{ txn.valueDate }}</strong>: R{{ "%.2f"|format(txn.amount) }}
                            </div>
                        {% endfor %}
                        {% if transactions|length > 3 %}
                            <div style="font-size: 12px; color: #999;">... +{{ transactions|length - 3 }} more</div>
                        {% endif %}
                    </td>
                    <td>
                        <button class="btn btn-primary" onclick="showDetails('{{ cid }}')">View Details</button>
                    </td>
                </tr>
                <!-- Details row (hidden by default) -->
                <tr id="details-{{ cid }}" style="display: none;">
                    <td colspan="4">
                        <div style="background: #f9f9f9; padding: 15px; border-radius: 4px;">
                            <h4>Transaction History for CID {{ cid }}</h4>
                            {% for txn in transactions %}
                            <div style="border-bottom: 1px solid #ddd; padding: 10px 0;">
                                <div><strong>Entry ID:</strong> {{ txn.entryId }}</div>
                                <div><strong>Date:</strong> {{ txn.valueDate }} | <strong>Amount:</strong> R{{ "%.2f"|format(txn.amount) }}</div>
                                <div><strong>Original Reference:</strong> <code>{{ txn.original_reference }}</code></div>
                                <div><strong>Original Remittance:</strong> <code>{{ txn.original_remittance_info }}</code></div>
                                <div><strong>Original CID:</strong> {{ txn.original_CID }} → <strong>Corrected to:</strong> {{ txn.corrected_CID }}</div>
                                <div><strong>Status:</strong>
                                    {% if txn.posted == 'yes' %}
                                        <span class="badge badge-success">Posted</span>
                                    {% else %}
                                        <span class="badge badge-warning">Not Posted</span>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p style="text-align: center; color: #999; padding: 40px 0;">No incorrect references found</p>
    {% endif %}
</div>

<style>
    .tab-btn {
        padding: 10px 20px;
        border: none;
        background: transparent;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        font-size: 14px;
        font-weight: 600;
        color: #666;
    }
    .tab-btn.active {
        color: #3498db;
        border-bottom-color: #3498db;
    }
    .tab-btn:hover {
        color: #2980b9;
    }
    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
    }
</style>

<script>
function switchTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });

    // Show selected tab
    document.getElementById('tab-' + tabName).classList.add('active');
    event.target.classList.add('active');
}

function showDetails(cid) {
    const detailsRow = document.getElementById('details-' + cid);
    if (detailsRow.style.display === 'none') {
        detailsRow.style.display = 'table-row';
    } else {
        detailsRow.style.display = 'none';
    }
}
</script>

{% endblock %}
